<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en">
<head>
	<title>ATutor Module Documentation</title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<meta name="author" content="Joel Kronenberg" />
	<meta name="description" content="ATutor module developer documentation" />

<style type="text/css">
body {
	line-height: 1.4em;
	color: #333;
	font-family: Verdana, sans-serif;
}
h1,h2,h3,h4 {
	font-family: "Lucida Grande", "Trebuchet MS", Verdana, sans-serif;
	color: #40659B;
	margin-bottom: 0px;
	padding-bottom: 0px;
}
h2 {
	padding-top: 0.3em;
	border-top: 1px solid #eaeaea;
}
body h2:first-child {
	border-top: none;
}
p {
	margin: 0px 0px 10px 10px;
	text-align: justify;
}
kbd {
	padding: 0px 1px 0px 1px;
	border-width: 1px 2px 2px 1px;
	border-style: solid;
	border-color: #edd #baa #baa #eed;
	white-space: pre;
}
kbd em {
	font-weight: bold;
	background-color: #efefef;
}
dl {
	margin: 0 10px
}
dl dt {
	margin-bottom: 5px;
}
dl dd {
	padding-top: 0px;
	padding-left: 5px;
	margin-left: 5%;
	border-left: 1px solid #c0c0c0;
	margin-bottom: 10px;
}
pre {
	font-family: Courier, monospace;
	border-left: 1px solid #761596;
	padding: 0px 0px 0px 10px;
	color: #777;
    margin: 0px 0px 10px 20px;
	font-size: 88%;
	line-height: 1.2em;
}
acronym {
	cursor: help;
}
</style>
</head>
<body>

<h2>Introduction</h2>
	<p>ATutor 1.5.2 introduced the concept of modules, providing developers with a framework to implement additional functionality in a coherent and loosely coupled way.</p>

	<p>The framework defines methods for assignable privileges, backing-up and restoring content, deleting course specific content, and side menu, student tool, instructor management, and administrator components. Additional methods of interaction have already been planned and will be added in future versions.</p>

	<p>The intent is to allow for the development and distribution of modules independently to the ongoing development and release of ATutor. The module structure should also allow for the creation of third party modules that cannot be distributed under the <acronym title="GNU Not Unix">GNU</acronym> General Public License, but that should be distributed separately under their own license.</p>

	<p>A <em>Hello World</em> example module is included with ATutor for developers who want to investigate this new feature. The module is found in the <kbd>mods/hello_world</kbd> directory.</p>

<h2>Structure</h2>
	<p>Modules are stored under ATutor's <kbd>mods</kbd> directory. <em>Core</em> modules are stored in the <kbd>mods/_core</kbd> subdirectory and are made available with every release of ATutor. These modules cannot be disabled by the administrator as they are vital to ATutor's functionality. <em>Standard</em> modules are stored in the <kbd>mods/_standard</kbd> subdirectory and are also made available with every release of ATutor. Standard modules can be disabled by the administrator. <em>Extra</em> modules are stored in the <kbd>mods</kbd> directory and are installed and distributed independently of ATutor. Although the process of developing modules is the same for each type of module, only <em>extra</em> modules can be distributed separately, while <em>core</em> and <em>standard</em> modules are added to the ATutor code repository (i.e. <acronym title="Subversion">SVN</acronym> trunk).</p>

	<p>Whenever a module identifier is needed within code, it should appear in lowercase with spaces converted to underscores.</p>

	<p>The module name, and hence the directory and function names (see below for additional details), must be unique across all possible modules. A module should not be made available if an existing module is already being distributed under that same name. It is up to the module developer to ensure that their module name is unique.</p>

	<h3>Directory Name</h3>
		<p>The name given to the directory must be chosen carefully. The name is used to namespace the module's function by prefixing required functions with that directory name. For example, a module named <em>Example Maker</em> should be placed in a directory named <kbd>example_maker</kbd> and the delete function would be named <kbd><em>example_maker</em>_delete()</kbd>.</p>

	<h3>Files</h3>
		<p>The following files should exist under the module's top level directory: <kbd>mods/<em>module_name</em></kbd>.</p>

		<dl>
			<dt><kbd>module.php</kbd></dt>
			<dd>This is the main module file which gets included whenever a page is loaded. <em>Required</em>.</dd>

			<dt><kbd>module.xml</kbd></dt>
			<dd>This file is used only for identifying the module for distribution and is only used when viewing a module's details. <em>Required</em>.</dd>

			<dt><kbd>module_backup.php</kbd></dt>
			<dd>This file is used when backing-up and restoring course content. <em>Optional</em>.</dd>

			<dt><kbd>module_delete.php</kbd></dt>
			<dd>This file is used when deleting course specific content. <em>Optional</em>.</dd>

			<dt><kbd>module_install.php</kbd></dt>
			<dd>This file is used when installing the module. <em>Required</em>.</dd>
		</dl>

	<h3>The <kbd>module.xml</kbd> File</h3>
		<p>The <kbd>module.xml</kbd> file is used for displaying information about the module before it is installed and is useful when distributing the module.</p>
<pre>
&lt;?xml version="1.0" encoding="ISO-8859-1"?> 
&lt;module version="0.1"> 
    &lt;name lang="en">Example Maker&lt;/name> 
    &lt;description lang="en">This is an example module that makes examples.&lt;/description> 
    &lt;maintainers>
        &lt;maintainer> 
            &lt;name>ATutor Team&lt;/name> 
            &lt;email>info@atutor.ca&lt;/email> 
        &lt;/maintainer>
        &lt;maintainer> 
            &lt;name>John Doe&lt;/name> 
            &lt;email>jd@example.com&lt;/email> 
        &lt;/maintainer>
    &lt;/maintainers> 
    &lt;url>http://www.example.com&lt;/url> 
    &lt;license>BSD&lt;/license> 
    &lt;release> 
        &lt;version>0.2&lt;/version> 
        &lt;date>2005-08-22&lt;/date> 
        &lt;state>stable&lt;/state> 
        &lt;notes>Fixes several bugs in previous version.&lt;/notes> 
    &lt;/release> 
&lt;/module>
</pre>

<h2>Installation</h2>
	<p>The <kbd>module_install.php</kbd> script gets executed during the installation process. If its execution results in <kbd>$msg->containsErrors()</kbd> evaluating to <kbd>TRUE</kbd>, then the errors are displayed and the user is prompted to correct them. The process is then repeated until errors are no longer being generated and the module is installed successfully. Eventually, it is up to the module to determine the logical steps involved in its installation. For example, it might be better to create the data directories before trying to create any database tables since creating the directory may require several attempts. Typically the flow we describe here should be suitable in most cases.</p>

	<p>Theoretically, the install script's execution is wide-open and does not have to adhere to the process outlined below or make use of any special privileges, provided it generates errors as appropriate.</p>

<pre># pseudo-code for installing a module:
while (there are errors)
    print the error message

    # inside module_install.php:
    define the privileges used

    if (create database tables is unsuccessful) then
        generate an error message

    if (there are no errors AND there is an SQL file) then
        execute the SQL file
end while

add the module to the system using the defined privileges
</pre>


	<h3>Specifying Privileges</h3>
		<p>Privileges control who has access to the course management and administrative sections.</p>
		
		<p>See the Authentication &amp; Privileges section for additional details using the privileges.</p>

		<dl>
			<dt><kbd>$_course_privilege</kbd></dt>
			<dd><p>This variable controls access to a course's management section and can take one of the following values:</p>
				<ul>
					<li><kbd>TRUE</kbd>: To use a custom assignable privilege level. If a custom privilege is created, the module will appear as an option when assigning privileges to enrolled students.</li>
					<li><kbd>AT_PRIV_ADMIN</kbd>: To use the instructor privilege. Only the instructor will be given access to the module's management section.</li>
					<li><kbd>FALSE</kbd>: To disable the privilege if there is no management section for the module.</li>
				</ul>
			</dd>

			<dt><kbd>$_admin_privilege</kbd></dt>
			<dd><p>This variable can take one of the following values:</p>
				<ul>
					<li><kbd>TRUE</kbd>: To use a custom assignable privilege level. If a custom privilege is created then the module will appear as an option when assigning privileges to administrators</li>
					<li><kbd>AT_ADMIN_PRIV_ADMIN</kbd>: To use the super administrator privilege. Only the super administrator will be given access to the module's administration section.</li>
				</ul>
			</dd>
		</dl>

		<p>Note that creating a privilege is not in itself enough to make the module appear in the Manage section! The hierarchy and navigation path to the management page must be set correctly. See the Navigation &amp; Hierarchy section for additional details.</p>

	<h3>Creating a Data Directory</h3>
		<p>It is best to keep the directory within the <kbd>AT_CONTENT_DIR</kbd> directory as it should already allow the creation of files and directories by the web server. It is then up to the module to create individual course directories as needed.</p>
<pre>
$directory = AT_CONTENT_DIR .'example_maker';

// check if the directory is writable
if (!is_dir($directory) && !@mkdir($directory)) {
    $msg->addError(array('MODULE_INSTALL', '&lt;li>'
                         .$directory
                         .' does not exist. Please create it.&lt;/li>'));
} else if (!is_writable($directory) && @chmod($directory, 0666)) {
    $msg->addError(array('MODULE_INSTALL', '&lt;li>'
                         . $directory
                         .' is not writable.&lt;/li>'));
} // else: it was created successfully.
</pre>

	<h3>Executing an <acronym title="Structured Query Language">SQL</acronym> File</h3>
		<p>If the module requires its own database tables or custom language, then it will have to create them itself. The <acronym title="Structured Query Language">SQL</acronym> can either be executed inline using <acronym title="PHP Hypertext Processor">PHP</acronym> database execution directly, or using the <kbd>SQLUtility</kbd> class to execute an external <acronym title="Structured Query Language">SQL</acronym> file.</p>
<pre>
if (!$msg->containsErrors() && file_exists(dirname(__FILE__) . '/module.sql')) {
    // deal with the SQL file:
    require(AT_INCLUDE_PATH . 'classes/sqlutility.class.php');
    $sqlUtility =& new SqlUtility();
    $sqlUtility->queryFromFile(dirname(__FILE__) . '/module.sql', TABLE_PREFIX);
}
</pre>

	<h3>Generating Errors</h3>
		<p>It is up to the module to generate and check for any errors that occur during the installation. An error message can be generated using <kbd>$msg->addError(array('MODULE_INSTALL', '&lt;li>your error msg goes here&lt;/li>'));</kbd>. Note that the text supplied to the error message is not translated. If the language should be localised, then a custom solution should be implemented to correctly supply the appropriate language.</p>

		<p>To check if any errors have been generated, use <kbd>$msg->containsErrors()</kbd> which evaluates to <kbd>TRUE</kbd> if a previous error has been generated.</p>

<h2>Authentication &amp; Privileges</h2>
	<p>See the <em>Installation: Specifying Privileges</em> section on creating privileges during the installation process.</p>

	<p>Authentication uses constants for the privilege levels. The privileges should be declared in the <kbd>module.php</kbd> file using the <kbd>$this->getPrivilege()</kbd> and <kbd>$this->getAdminPrivilege()</kbd> methods, respectively.</p>

<pre>
define('AT_PRIV_FORUMS',       $this->getPrivilege()      );
define('AT_ADMIN_PRIV_FORUMS', $this->getAdminPrivilege() );
</pre>

	<p>Once declared, a page can then authenticate against those privileges using either the <kbd>authentication()</kbd> or the <kbd>admin_authenticate()</kbd> functions.</p>

<pre>
define('AT_INCLUDE_PATH', '../include/');
require(AT_INCLUDE_PATH.'vitals.inc.php');
// authenticate the administrator forums section:
admin_authenticate(AT_ADMIN_PRIV_FORUMS);
</pre>

<h2>Localisation</h2>
	<p>Although a module can be created with all hard-coded language, it is recommended to use ATutor's localisation functions. All of ATutor's language is stored in the database, which is then retrieved using the <kbd>_AT()</kbd> function for simple terms and the <kbd>$msg</kbd> object for feedback and error messages.</p>

	<p>Additional details on localising ATutor can be found on the <a href="http://atutor.ca/atutor/docs/translate.php">Thing You Should Know Before Translating</a> and <a href="http://atutor.ca/development/documentation/guidelines.html#fn-at">ATutor Developer Documentation</a> pages.</p>

	<p>Module-specific language should be inserted into the <kbd>language_text</kbd> table during the installation process. The fields are as follows:</p>
    	     	     	     	     	  
	<dl>
		<dt><kbd>language_code</kbd></dt>
		<dd>The ISO-639-1 language code plus locale.</dd>

		<dt><kbd>variable</kbd></dt>
		<dd>Set to <kbd>_module</kbd> for modules.</dd>

		<dt><kbd>term</kbd></dt>
		<dd>The variable used for retrieving the language.</dd>

		<dt><kbd>text</kbd></dt>
		<dd>The language text.</dd>

		<dt><kbd>revised_date</kbd></dt>
		<dd>Set to <kbd>NOW()</kbd> for modules.</dd>

		<dt><kbd>context</kbd></dt>
		<dd>Short description of the language text.</dd>
	</dl>

<pre>
# Insert module specific language:
INSERT INTO `language_text` VALUES ('en',
                                    '_module',
                                    'example_maker',
                                    'Example Maker',
                                     NOW(),
                                    'the module title');
</pre>



<h2>Custom Style Sheets</h2>
	<p>A custom style sheet can be linked into pages by setting <kbd>$_custom_css</kbd> to be the absolute path to the style sheet. This variable must be set on every page that requires that style sheet.</p>

<pre>
define('AT_INCLUDE_PATH', '../../include/');
require(AT_INCLUDE_PATH.'vitals.inc.php');
// using a custom style sheet:
$_custom_css = $_base_path . 'mods/example_maker/module.css';
</pre>


<h2>Side Menu Boxes</h2>
	<p>Side menu boxes generally appear in a column at the side of a course (though this layout can be altered by a theme). A module may implement one or more side menu boxes.</p>

	<p>Side menus are specified using the <kbd>$_module_stacks</kbd> array in <kbd>module.php</kbd>. <kbd>$_module_stacks</kbd> have the attributes <kbd>title_var</kbd> (or <kbd>title</kbd>) and <kbd>file</kbd>. The <kbd>title_var</kbd> value is the language key used for that box; the title will be generated by executing <kbd>_AT($title_var)</kbd>. If <kbd>title</kbd> is set instead, a hard-coded title will be used. The <kbd>file</kbd> attribute specifies the absolute path to the side menu's include file.</p>

	<p>The key to the <kbd>$_module_stacks</kbd> should be the name of the module.</p>

<pre>
$_module_stacks['example_maker'] = array('title_var' => 'example_maker', 
                                         'file' => dirname(__FILE__).'\side_menu.inc.php');
</pre>

	<p>Creating a side menu box involves using the <kbd>$savant</kbd> template object and assigning the output of the box to the <kbd>dropdown_contents</kbd> variable.</p>

<pre>
&lt;?php global $savant;

$box_content = 'This is my side menu box';

$savant->assign('dropdown_contents', $box_content);

$savant->assign('title', _AT('example_maker'));
$savant->display('include/box.tmpl.php');
?>
</pre>


<h2>Student Tools</h2>
	<p>Student tools are pages linked from the home page or the main navigation of courses. A module can only implement one student tool. An instructor controls which student tools are available to a course using the <em>Student Tools</em> section found under <em>Manage</em>.</p>

	<p>The tool main page must be specified using the <kbd>$_student_tool</kbd> variable in the <kbd>module.php</kbd> file. The value of that variable must be the relative path to the file from the ATutor base directory (not the module directory). Example: <kbd>$_student_tool = 'mods/example_maker/index.php';</kbd>.</p>

	<p>For the tool to correctly appear its Navigation &amp; Hierarchy must be defined correctly. If the tool is to have an instructor management section then the <em>parent</em> must be specified as being <kbd>tools/index.php</kbd> and the module must have a non-zero privilege level.</p>

<h2>Navigation &amp; Hierarchy</h2>
	<p><em>Every</em> page in ATutor must have an entry in the global <kbd>$_pages</kbd> array where the key to the array is the relative path to the file from ATutor's base directory. Module pages are specified using the <kbd>$_module_pages</kbd> array, which are then merged into the <kbd>$_pages</kbd> array when the <kbd>module.php</kbd> file is loaded. The array supports the following attributes:</p>

	<dl>
		<dt><kbd>title_var</kbd></dt>
		<dd>The language variable to be used with <kbd>_AT()</kbd>.</dd>

		<dt><kbd>title</kbd></dt>
		<dd>The hard-coded version of the language title. If set, overrides the usage of <kbd>_AT(title_var)</kbd>. This version is not language independent.</dd>

		<dt><kbd>parent</kbd></dt>
		<dd>The relative ATutor path to the parent page. Omit for Student Tools.</dd>

		<dt><kbd>img</kbd></dt>
		<dd>The relative ATutor path to the icon to use. Only for Student Tools.</dd>

		<dt><kbd>children</kbd></dt>
		<dd>An array whose values are relative ATutor paths to sub pages.</dd>

		<dt><kbd>guide</kbd></dt>
		<dd>The the section of the handbook that the module page should link to. Not used for modules at this time.</dd>
	</dl>

	<p>For pages to appear in the instructor Manage section, their <kbd>parent</kbd> field must be set to <kbd>tools/index.php</kbd>.</p>

<pre>
$path = 'mods/example_maker/';

// the student tool:
$_module_pages[$path.'index.php']['title_var'] = 'example_maker';
$_module_pages[$path.'index.php']['img']       = $path.'icon.gif';
$_module_pages[$path.'index.php']['children']  = array($path.'sub.php', $path.'more.php');

    $_module_pages[$path.'sub.php']['title_var'] = 'sub_page';
    $_module_pages[$path.'sub.php']['parent']    = $path.'index.php';

    $_module_pages[$path.'more.php']['title_var'] = 'more_page';
    $_module_pages[$path.'more.php']['parent']    = $path.'index.php';

// the instructor page:
$_module_pages[$path . 'inst_index.php']['title_var'] = 'example_maker';
$_module_pages[$path . 'inst_index.php']['parent']    = 'tools/index.php';
</pre>

<h2>Course Deletion</h2>
	<p>When a course is being deleted, or when a back-up is being restored by overriding (i.e. deleting) existing content, a module has to ensure that the content for that course is also deleted. If the module maintains course data directories, then those directories have to either be emptied or deleted. If the module uses database tables for course content, then it has to delete the appropriate entries for that course.</p>

	<p>The function used to delete the course content for that module must be stored in the <kbd>module_delete.php</kbd> file and named <kbd><em>module_name</em>_delete()</kbd>. The delete function takes a single argument which is the ID of the course to delete.</p>

<pre>
&lt;?php
function example_maker_delete($course) {
    global $db;

    // delete directory
    $path = AT_CONTENT_DIR . 'example_maker/' . $course . '/';
    clr_dir($path);

    // delete from database
    $sql = "DELETE 
            FROM ".TABLE_PREFIX."example_content 
            WHERE course_id=$course";
    mysql_query($sql, $db);
}
?>
</pre>

<h2>Backing-Up and Restoring</h2>
	<p>It is possible for a module to include its content when a course backup is being created or restored. Backups support database tables with foreign-key constraints as well as course specific directories.</p>

	<h3>Directories</h3>
		<p>A module can backup as many directories as it requires, all specified using the <kbd>$dirs</kbd> array variable.</p>

		<p>The example below uses the special <kbd>?</kbd> token as the place holder for the course ID. When the course is backed-up, the question mark will be replaced with the correct course ID. The key to the array is the unique name of the directory to be used inside the backup archive file. The same information to create the backup is also used to restore it, so no additional details are required.</p>
<pre>
$dirs = array();
$dirs['example_maker/'] = AT_CONTENT_DIR . 'example_maker/?/';
</pre>


	<h3>Database Tables</h3>
		<p>There are two parts to backing-up and restoring a module's database tables. First, the <acronym title="Structured Query Language">SQL</acronym> queries must be specified using the <kbd>$sql</kbd> array variable and then the restore functions must convert the rows so that they can be inserted into the database tables.</p>

		<p>The example below uses the special <kbd>?</kbd> token as the place holder for the course ID. When the course is backed-up the question-mark will be replaced with the correct course ID. The key to the array is the unique name of the <acronym title="Comma Separated Values">CSV</acronym> file to save in the backup archive, without the extension. The <acronym title="Structured Query Language">SQL</acronym> query itself must only select the fields that will be backed up. If there are foreign key constraints to preserve then the key will have to be retrieved as well so that it can be used when restoring the tables.</p>

<pre>
$sql = array();
$sql['example']  = 'SELECT title FROM '.TABLE_PREFIX.'example WHERE course_id=?';
</pre>

		<p>For each key in the <kbd>$sql</kbd> array there must be a function with the same name, but suffixed with <kbd>_convert</kbd>. The <kbd><em>tbl_name</em>_convert()</kbd> function must return the newly transformed row with respect to the version of ATutor that was used to generate the <acronym title="Comma Separated Values">CSV</acronym> file. The function accepts the following arguments:</p>

		<dl>
			<dt><kbd>$row</kbd></dt>
			<dd>An array which represents a single row in the <acronym title="Comma Separated Values">CSV</acronym> file.</dd>

			<dt><kbd>$course_id</kbd></dt>
			<dd>The course ID which this content should be associated with.</dd>
			
			<dt><kbd>$table_id_map</kbd></dt>
			<dd>An associative array representing previously restored tables and their new keys. Used to preserve foreign key constraints.</dd>

			<dt><kbd>$version</kbd></dt>
			<dd>The version of ATutor that was used to generate this file.</dd>
		</dl>

<pre>
function example_convert($row, $course_id, $table_id_map, $version) {
    $new_row = array();
    $new_row[0]  = 0; // auto-increment field
    $new_row[1]  = $course_id;
    $new_row[2]  = $row[1]; // the title
    if (version_compare($version, '1.5.2', '&lt;')) {
        // this field did not exist prior to 1.5.2
        $new_row[3] = '';
    } else {
        $new_row[3] = $row[2];
    }

    return $new_row;
}
</pre>
</body>
</html>